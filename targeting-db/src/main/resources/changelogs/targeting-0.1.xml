<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        logicalFilePath="/usr/share/targeting/db/targeting.xml"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet id="0.1" author="svnovikov">
        <tagDatabase tag="0.1"/>
    </changeSet>

    <changeSet id="0.1-1" author="svnovikov" context="schemas">
        <sql>
            CREATE SCHEMA dict;
            CREATE SCHEMA obj;
            CREATE SCHEMA conf;
        </sql>
        <rollback>
            <sql>
                DROP SCHEMA dict;
                DROP SCHEMA obj;
                DROP SCHEMA conf;
            </sql>
        </rollback>
    </changeSet>

    <changeSet id="0.1-2" author="svnovikov" context="schemas">
        <createTable tableName="type" schemaName="dict" remarks="Типы контента">
            <column name="id" type="integer" autoIncrement="true" remarks="Уникальный ИД">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="mtype" type="varchar" remarks="Строка, передаваемая в запросе в поле mtype">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="name" type="varchar" remarks="Описание типа">
                <constraints nullable="false"/>
            </column>
            <column name="deleted" type="boolean" remarks="Флаг, что запись удалена" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="priority" schemaName="dict" remarks="Приоритеты">
            <column name="id" type="integer" autoIncrement="true" remarks="Уникальный ИД">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="value" type="integer" remarks="Числовое значение приоритета">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="name" type="varchar" remarks="Описание приоритета">
                <constraints nullable="false"/>
            </column>
            <column name="deleted" type="boolean" remarks="Флаг, что запись удалена" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="attr" schemaName="dict" remarks="Атрибуты таргетинга">
            <column name="id" type="integer" autoIncrement="true" remarks="Уникальный ИД">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="tag" type="varchar" remarks="Сокращение, используемое при передаче данных">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="name" type="varchar" remarks="Имя атрибута">
                <constraints nullable="false"/>
            </column>
            <column name="deleted" type="boolean" remarks="Флаг, что запись удалена" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="attr_value" schemaName="dict" remarks="Значения атрибутов таргетинга">
            <column name="id" type="integer" autoIncrement="true" remarks="Уникальный ИД">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="aid" type="integer" remarks="ИД атрибута">
                <constraints nullable="false"/>
            </column>
            <column name="value" type="varchar" remarks="Значение атрибута">
                <constraints nullable="false"/>
            </column>
            <column name="deleted" type="boolean" remarks="Флаг, что запись удалена" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="fk_attr_value_aid"
                                 baseTableName="attr_value" baseTableSchemaName="dict"
                                 baseColumnNames="aid"
                                 referencedTableName="attr" referencedTableSchemaName="dict"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE" onUpdate="CASCADE"/>
    </changeSet>

    <changeSet id="0.1-3" author="svnovikov" context="schemas">
        <createTable tableName="app" schemaName="obj" remarks="Приложения">
            <column name="id" type="integer" autoIncrement="true" remarks="Уникальный ИД">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="appid" type="integer" remarks="ИД приложения">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="name" type="varchar" remarks="Описание приложения">
                <constraints nullable="false"/>
            </column>
            <column name="deleted" type="boolean" remarks="Флаг, что объект удален" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="ado" schemaName="obj" remarks="Рекламные материалы">
            <column name="id" type="integer" autoIncrement="true" remarks="Уникальный ИД">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="appid" type="integer" remarks="ИД приложения">
                <constraints nullable="false"/>
            </column>
            <column name="uuid" type="UUID" remarks="UUID объекта">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="flink" type="integer" remarks="Ссылка на файл объекта">
                <constraints nullable="false"/>
            </column>
            <column name="ilink" type="integer" remarks="Ссылка на изображение объекта">
                <constraints nullable="false"/>
            </column>
            <column name="tid" type="integer" remarks="ИД типа контента">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="varchar" remarks="Имя объекта"/>
            <column name="attr" type="varchar" remarks="Список значений атрибутов таргетинга"/>
            <column name="deleted" type="boolean" remarks="Флаг, что объект удален" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="fk_ado_appid"
                                 baseTableName="ado" baseTableSchemaName="obj"
                                 baseColumnNames="appid"
                                 referencedTableName="app" referencedTableSchemaName="obj"
                                 referencedColumnNames="appid"
                                 onDelete="RESTRICT" onUpdate="RESTRICT"/>
        <addForeignKeyConstraint constraintName="fk_ado_tid"
                                 baseTableName="ado" baseTableSchemaName="obj"
                                 baseColumnNames="tid"
                                 referencedTableName="type" referencedTableSchemaName="dict"
                                 referencedColumnNames="id"
                                 onDelete="RESTRICT" onUpdate="RESTRICT"/>
        <createTable tableName="group" schemaName="obj" remarks="Группы рекламных материалов">
            <column name="id" type="integer" autoIncrement="true" remarks="Уникальный ИД">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="appid" type="integer" remarks="ИД приложения">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="varchar" remarks="Имя объекта">
                <constraints nullable="false"/>
            </column>
            <column name="attr" type="varchar" remarks="Список значений атрибутов таргетинга"/>
            <column name="weight" type="integer" remarks="Статистический вес">
                <constraints nullable="false"/>
            </column>
            <column name="priorityid" type="integer" remarks="ИД приоритета">
                <constraints nullable="false"/>
            </column>
            <column name="enable" type="boolean" remarks="Флаг, что объект используется" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
            <column name="deleted" type="boolean" remarks="Флаг, что объект удален" defaultValueBoolean="false">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="fk_group_appid"
                                 baseTableName="group" baseTableSchemaName="obj"
                                 baseColumnNames="appid"
                                 referencedTableName="app" referencedTableSchemaName="obj"
                                 referencedColumnNames="appid"
                                 onDelete="CASCADE" onUpdate="CASCADE"/>
        <addForeignKeyConstraint constraintName="fk_group_priorityid"
                                 baseTableName="group" baseTableSchemaName="obj"
                                 baseColumnNames="priorityid"
                                 referencedTableName="priority" referencedTableSchemaName="dict"
                                 referencedColumnNames="id"
                                 onDelete="RESTRICT" onUpdate="RESTRICT"/>
        <createTable tableName="ado2group" schemaName="obj" remarks="Связь между группами и рекламными материалами">
            <column name="oid" type="integer" remarks="ИД рекламного материала">
                <constraints nullable="false"/>
            </column>
            <column name="gid" type="integer" remarks="ИД группы">
                <constraints nullable="false"/>
            </column>
            <column name="enable" type="boolean" remarks="Флаг, что запись используется" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="fk_ado2group_oid"
                                 baseTableName="ado2group" baseTableSchemaName="obj"
                                 baseColumnNames="oid"
                                 referencedTableName="ado" referencedTableSchemaName="obj"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE" onUpdate="CASCADE"/>
        <addForeignKeyConstraint constraintName="fk_ado2group_gid"
                                 baseTableName="ado2group" baseTableSchemaName="obj"
                                 baseColumnNames="gid"
                                 referencedTableName="group" referencedTableSchemaName="obj"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE" onUpdate="CASCADE"/>
    </changeSet>

    <changeSet id="0.1-4" author="svnovikov" context="schemas">
        <createTable tableName="status" schemaName="conf" remarks="Статус конфигурации">
            <column name="id" type="integer" autoIncrement="true" remarks="Уникальный ИД">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="appid" type="integer" remarks="ИД приложения">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="value" type="smallint" remarks="Значение статуса конфигурации" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
            <column name="utime" type="DATETIME" remarks="Время обновления статуса" defaultValueComputed="now()"/>
            <column name="cid" type="smallint" remarks="Текущая версия конфигурации (0 или 1)" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="fk_status_appid"
                                 baseTableName="status" baseTableSchemaName="conf"
                                 baseColumnNames="appid"
                                 referencedTableName="app" referencedTableSchemaName="obj"
                                 referencedColumnNames="appid"
                                 onDelete="CASCADE" onUpdate="CASCADE"/>
        <createTable tableName="current" schemaName="conf" remarks="Текущая конфигурация">
            <column name="id" type="integer" autoIncrement="true" remarks="Уникальный ИД">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="appid" type="integer" remarks="ИД приложения">
                <constraints nullable="false"/>
            </column>
            <column name="oid" type="integer" remarks="ИД рекламного материала">
                <constraints nullable="false"/>
            </column>
            <column name="attr" type="varchar" remarks="Список значений атрибутов таргетинга"/>
            <column name="weight" type="integer" remarks="Статистический вес">
                <constraints nullable="false"/>
            </column>
            <column name="priorityid" type="integer" remarks="ИД приоритета">
                <constraints nullable="false"/>
            </column>
            <column name="cid" type="smallint" remarks="Текущая версия конфигурации (0 или 1)" defaultValueNumeric="0">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addForeignKeyConstraint constraintName="fk_current_appid"
                                 baseTableName="current" baseTableSchemaName="conf"
                                 baseColumnNames="appid"
                                 referencedTableName="app" referencedTableSchemaName="obj"
                                 referencedColumnNames="appid"
                                 onDelete="RESTRICT" onUpdate="RESTRICT"/>
        <addForeignKeyConstraint constraintName="fk_current_oid"
                                 baseTableName="current" baseTableSchemaName="conf"
                                 baseColumnNames="oid"
                                 referencedTableName="ado" referencedTableSchemaName="obj"
                                 referencedColumnNames="id"
                                 onDelete="RESTRICT" onUpdate="RESTRICT"/>
        <addForeignKeyConstraint constraintName="fk_current_priorityid"
                                 baseTableName="current" baseTableSchemaName="conf"
                                 baseColumnNames="priorityid"
                                 referencedTableName="priority" referencedTableSchemaName="dict"
                                 referencedColumnNames="id"
                                 onDelete="RESTRICT" onUpdate="RESTRICT"/>
    </changeSet>

    <changeSet id="0.1-5" author="svnovikov" context="initdata">
        <insert tableName="type" schemaName="dict">
            <column name="mtype" value="image"/>
            <column name="name" value="Изображение"/>
        </insert>
        <insert tableName="type" schemaName="dict">
            <column name="mtype" value="video"/>
            <column name="name" value="Видео"/>
        </insert>
        <insert tableName="type" schemaName="dict">
            <column name="mtype" value="swf"/>
            <column name="name" value="Flash-анимация"/>
        </insert>
        <rollback>
            <sql>
                TRUNCATE TABLE dict.type CASCADE;
            </sql>
        </rollback>
    </changeSet>

    <changeSet id="0.1-6" author="svnovikov" context="initdata">
        <insert tableName="priority" schemaName="dict">
            <column name="value" valueNumeric="10"/>
            <column name="name" value="Низкий"/>
        </insert>
        <insert tableName="priority" schemaName="dict">
            <column name="value" valueNumeric="100"/>
            <column name="name" value="Обычный"/>
        </insert>
        <insert tableName="priority" schemaName="dict">
            <column name="value" valueNumeric="1000"/>
            <column name="name" value="Высокий"/>
        </insert>
        <rollback>
            <sql>
                TRUNCATE TABLE dict.priority CASCADE;
            </sql>
        </rollback>
    </changeSet>

</databaseChangeLog>
